// CÃ³digo para testar upload pelo console
// Copie e cole TUDO no console do navegador (F12)

// Detecta API_BASE automaticamente
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:4000'
  : 'https://agente-financeiro-mk-backend.onrender.com';

console.log('ğŸŒ API_BASE:', API_BASE);

// Cria um input de arquivo
const input = document.createElement('input');
input.type = 'file';
input.accept = '.xlsx,.xls,.xlsm';
input.style.display = 'none';
document.body.appendChild(input);

// Quando selecionar arquivo
input.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  console.log('ğŸ“¤ Enviando arquivo:', file.name);
  console.log('ğŸ“¡ Para:', `${API_BASE}/finance/upload`);
  
  try {
    const res = await fetch(`${API_BASE}/finance/upload`, {
      method: 'POST',
      body: formData,
    });
    
    const data = await res.json();
    console.log('ğŸ“¥ Resposta completa:', data);
    
    if (data.success) {
      console.log(`âœ… Sucesso! ${data.imported} transaÃ§Ãµes importadas.`);
      
      // Aguarda 1 segundo para garantir que o backend processou
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Tenta atualizar os dados se as funÃ§Ãµes existirem
      if (typeof loadTransactions === 'function') {
        console.log('ğŸ”„ Carregando transaÃ§Ãµes...');
        await loadTransactions();
      }
      if (typeof loadSummary === 'function') {
        console.log('ğŸ”„ Carregando resumo...');
        await loadSummary();
      }
      if (typeof updateAll === 'function') {
        console.log('ğŸ”„ Atualizando interface...');
        updateAll();
      }
      
      alert(`âœ… Sucesso! ${data.imported} transaÃ§Ãµes importadas.\n\nA pÃ¡gina vai recarregar em 2 segundos...`);
      
      // Recarrega a pÃ¡gina apÃ³s 2 segundos
      setTimeout(() => {
        console.log('ğŸ”„ Recarregando pÃ¡gina...');
        location.reload();
      }, 2000);
    } else {
      alert(`âŒ Erro: ${data.message || data.error}`);
    }
  } catch (err) {
    console.error('âŒ Erro completo:', err);
    alert(`âŒ Erro: ${err.message}`);
  }
});

// Abre o seletor de arquivo
console.log('ğŸ“ Abrindo seletor de arquivo...');
input.click();
