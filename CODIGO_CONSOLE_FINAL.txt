// CÃ³digo FINAL - sem erros de variÃ¡vel duplicada
// Copie e cole TUDO no console (F12)

// Usa API_BASE existente ou cria um novo
const API_BASE_UPLOAD = window.API_BASE || (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:4000'
  : 'https://agente-financeiro-mk-backend.onrender.com');

console.log('ğŸŒ API_BASE_UPLOAD:', API_BASE_UPLOAD);

// FunÃ§Ã£o para verificar se os dados foram salvos
async function verificarDadosUpload() {
  try {
    console.log('ğŸ” Verificando se os dados foram salvos...');
    const res = await fetch(`${API_BASE_UPLOAD}/finance/transactions?page=1&limit=5`);
    const data = await res.json();
    console.log('ğŸ“Š Dados no banco:', data);
    if (data.items && data.items.length > 0) {
      console.log(`âœ… CONFIRMADO: ${data.items.length} transaÃ§Ãµes no banco!`);
      return true;
    } else {
      console.log('âš ï¸ Nenhuma transaÃ§Ã£o encontrada no banco ainda...');
      return false;
    }
  } catch (err) {
    console.error('âŒ Erro ao verificar dados:', err);
    return false;
  }
}

// Cria um input de arquivo
const inputUpload = document.createElement('input');
inputUpload.type = 'file';
inputUpload.accept = '.xlsx,.xls,.xlsm';
inputUpload.style.display = 'none';
document.body.appendChild(inputUpload);

// Quando selecionar arquivo
inputUpload.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  console.log('ğŸ“¤ Enviando arquivo:', file.name);
  console.log('ğŸ“¡ Para:', `${API_BASE_UPLOAD}/finance/upload`);
  
  try {
    const res = await fetch(`${API_BASE_UPLOAD}/finance/upload`, {
      method: 'POST',
      body: formData,
    });
    
    const data = await res.json();
    console.log('ğŸ“¥ Resposta completa:', data);
    
    if (data.success) {
      console.log(`âœ… Upload concluÃ­do! ${data.imported} transaÃ§Ãµes importadas.`);
      
      // Aguarda 2 segundos para garantir que o backend salvou
      console.log('â³ Aguardando 2 segundos para backend processar...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Verifica se os dados foram salvos
      const dadosSalvos = await verificarDadosUpload();
      
      if (dadosSalvos) {
        console.log('âœ… Dados confirmados no banco!');
        alert(`âœ… Sucesso! ${data.imported} transaÃ§Ãµes importadas e confirmadas no banco!\n\nA pÃ¡gina vai recarregar agora...`);
      } else {
        console.log('âš ï¸ Dados ainda nÃ£o aparecem no banco, mas vamos recarregar mesmo assim...');
        alert(`âœ… Upload concluÃ­do! ${data.imported} transaÃ§Ãµes importadas.\n\nA pÃ¡gina vai recarregar para verificar...`);
      }
      
      // SEMPRE recarrega a pÃ¡gina apÃ³s 1 segundo
      setTimeout(() => {
        console.log('ğŸ”„ Recarregando pÃ¡gina...');
        window.location.reload(true); // true = forÃ§a recarregar do servidor (ignora cache)
      }, 1000);
      
    } else {
      alert(`âŒ Erro: ${data.message || data.error}`);
    }
  } catch (err) {
    console.error('âŒ Erro completo:', err);
    alert(`âŒ Erro: ${err.message}`);
  }
});

// Abre o seletor de arquivo
console.log('ğŸ“ Abrindo seletor de arquivo...');
inputUpload.click();

